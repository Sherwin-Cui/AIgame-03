# 草船借箭游戏 - Debug手册

## 目的
本手册记录项目开发过程中遇到的各种Bug、调试过程、解决方案和经验教训，帮助开发者快速定位和解决类似问题。

## 📋 功能问题快速导航

### 🎯 按问题类型查找
- **事件弹窗问题** → [案例1：抉择事件弹窗无法显示问题](#案例1抉择事件弹窗无法显示问题)
- **AI响应解析问题** → [格式不匹配错误](#1-格式不匹配错误)
- **事件处理器问题** → [处理器缺失错误](#2-处理器缺失错误)
- **代码重复问题** → [重复代码错误](#3-重复代码错误)

### 🔧 按开发阶段查找
- **功能开发前** → [常见调试方法](#常见调试方法)
- **功能开发中** → [调试工具和技巧](#调试工具和技巧)
- **功能开发后** → [数据验证](#数据验证)
- **代码重构时** → [经验教训总结](#经验教训总结)

### 🗂️ 按文件类型查找
- **gameData.js相关** → [代码同步修改指南](#代码同步修改指南)
- **gameEngine.js相关** → [案例1第二、三阶段](#第二阶段事件处理器缺失问题)
- **promptBuilder.js相关** → [案例1第一阶段](#第一阶段格式不匹配问题)
- **uiManager.js相关** → [事件弹窗问题](#案例1抉择事件弹窗无法显示问题)

### ⚡ 紧急问题处理
- **功能完全不工作** → [数据流追踪法](#1-数据流追踪法)
- **部分功能异常** → [对比分析法](#2-对比分析法)
- **修改后出错** → [逐步回退法](#3-逐步回退法)

---

## 重大Bug案例

### 案例1：抉择事件弹窗无法显示问题

**问题描述：** 游戏中的抉择事件1弹窗无法正常显示，玩家无法进行选择。

**调试过程与错误分析：**

#### 第一阶段：格式不匹配问题
**错误1：AI响应格式与解析器不匹配**
- **现象：** AI响应中使用`event_suggestion`和`item_grant`字段
- **期望：** 解析器期望`events`和`items`字段
- **根本原因：** `promptBuilder.js`中定义的输出格式与`aiManager.js`中的解析逻辑不一致
- **解决方案：** 修改`promptBuilder.js`中的`getOutputRequirements`方法，统一字段名称
- **经验教训：** 数据格式定义和解析逻辑必须保持严格一致，任何不匹配都会导致功能失效

#### 第二阶段：事件处理器缺失问题
**错误2：事件名称与处理器不匹配**
- **现象：** AI响应返回`choice_event1: true`，但控制台显示"事件处理器不存在"
- **期望：** 事件能够正常触发弹窗
- **根本原因：** `gameEngine.js`中只注册了`acceptChallenge`处理器，缺少`choice_event1`处理器
- **临时解决方案：** 添加`choice_event1`处理器，与`acceptChallenge`功能相同
- **问题：** 这种方案导致大量重复代码

#### 第三阶段：代码重构优化
**错误3：事件处理器设计不合理**
- **现象：** 每个事件都需要单独的处理器，存在大量重复代码
- **期望：** 通用的事件处理逻辑
- **根本原因：** 缺乏抽象设计，没有考虑到事件处理的通用性
- **最终解决方案：** 创建通用事件处理器工厂函数
- **经验教训：** 设计时要考虑扩展性，避免为每个相似功能编写重复代码

**最终解决方案代码：**
```javascript
// 通用选择事件处理器
const createChoiceEventHandler = (eventName) => {
    return (gameState) => {
        const eventData = this.stateManager.gameData?.events?.[eventName];
        if (eventData && eventData.type === 'choice_event') {
            return {
                trigger: true,
                id: eventData.id,
                title: eventData.title,
                type: eventData.type,
                description: eventData.description,
                choices: Object.entries(eventData.options).map(([key, option]) => ({
                    key,
                    text: option.text,
                    consequences: option.consequences
                }))
            };
        }
        return { trigger: false };
    };
};

// 批量注册所有选择事件
const choiceEvents = ['choice_event1', 'choice_event2', 'choice_event3', 'choice_event4'];
choiceEvents.forEach(eventName => {
    this.eventHandlers.set(eventName, createChoiceEventHandler(eventName));
});
```

**涉及的文件：**
- `js/promptBuilder.js` - 修复AI响应格式定义
- `js/core/gameEngine.js` - 重构事件处理器
- `js/data/gameData.js` - 事件数据结构

**调试技巧：**
1. **使用控制台日志追踪数据流：** 从AI响应→解析→事件触发→UI显示的完整链路
2. **对比模拟响应和真实响应：** 发现格式差异的有效方法
3. **检查事件注册：** 确保所有事件都有对应的处理器
4. **代码重构时保持向后兼容：** 保留旧的处理器名称作为别名

---

## 常见调试方法

### 1. 数据流追踪法
**适用场景：** 功能链路较长，不确定在哪个环节出错
**方法：**
1. 在关键节点添加`console.log`
2. 追踪数据从输入到输出的完整流程
3. 对比期望值和实际值

### 2. 对比分析法
**适用场景：** 有工作的参考实现和不工作的实现
**方法：**
1. 对比两种实现的差异
2. 逐步替换不同部分
3. 定位具体的差异点

### 3. 逐步回退法
**适用场景：** 功能之前正常，某次修改后出错
**方法：**
1. 回退到最后一个正常版本
2. 逐步应用修改
3. 确定引入问题的具体修改

---

## 代码同步修改指南

### 游戏状态变量修改

#### 添加新的游戏状态变量
**需要同步修改的文件：**
- `gameData.js` - globalState 对象
- `gameStateManager.js` - 初始状态定义
- `gameData.js` - dataValidation.gameStateRanges 数值范围
- `游戏数据所有变量.md` - 变量表文档

#### 删除游戏状态变量
**需要同步修改的文件：**
- `gameData.js` - globalState 对象
- `gameStateManager.js` - 初始状态定义
- `gameData.js` - dataValidation.gameStateRanges 数值范围
- `gameData.js` - 相关章节的 successConditions/failureConditions
- `gameData.js` - 相关事件的 effects
- `gameData.js` - dialogueRules 中的触发器
- `游戏数据所有变量.md` - 变量表文档

### 事件系统修改

#### 添加新事件
**需要同步修改的文件：**
- `gameData.js` - 对应的事件对象（dialogue_event/choice_event/check_event等）
- `gameEngine.js` - 如果是新类型事件，需要添加处理器
- `游戏脚本.md` - 事件的剧情描述

#### 修改事件格式
**需要同步修改的文件：**
- `promptBuilder.js` - AI响应格式定义
- `aiManager.js` - 响应解析逻辑
- `gameEngine.js` - 事件处理逻辑
- `gameData.js` - 事件数据结构

---

## 常见错误模式

### 1. 格式不匹配错误
**特征：** 数据存在但无法正确解析或处理
**常见原因：**
- 字段名不一致
- 数据类型不匹配
- 结构层级错误

**预防措施：**
- 建立统一的数据格式规范
- 使用TypeScript或JSDoc进行类型约束
- 编写单元测试验证数据格式

### 2. 处理器缺失错误
**特征：** 事件触发但无对应处理逻辑
**常见原因：**
- 忘记注册处理器
- 处理器名称不匹配
- 条件判断错误

**预防措施：**
- 建立处理器注册检查机制
- 使用统一的命名规范
- 添加默认处理器

### 3. 重复代码错误
**特征：** 相似功能有多份实现
**常见原因：**
- 缺乏抽象设计
- 临时解决方案未及时重构
- 不了解现有实现

**预防措施：**
- 代码审查时关注重复代码
- 及时重构临时解决方案
- 建立代码复用机制

---

## 调试工具和技巧

### 1. 浏览器开发者工具
- **Console：** 查看错误信息和调试日志
- **Network：** 检查API请求和响应
- **Sources：** 设置断点调试
- **Application：** 检查本地存储

### 2. 代码调试技巧
- **添加详细日志：** 记录关键变量和执行路径
- **使用断点：** 在关键位置暂停执行
- **单步调试：** 逐行执行代码
- **条件断点：** 在特定条件下触发断点

### 3. 数据验证
- **类型检查：** 确保数据类型正确
- **范围检查：** 确保数值在合理范围内
- **存在性检查：** 确保必需的数据存在
- **格式检查：** 确保数据格式符合预期

---

## 经验教训总结

1. **系统性思考：** 修改一个组件时，要考虑对整个系统的影响
2. **格式一致性：** 数据格式定义和解析逻辑必须严格一致
3. **代码复用：** 相似功能应该抽象为通用组件，避免重复代码
4. **向后兼容：** 重构时要考虑现有代码的兼容性
5. **调试日志：** 关键节点要有详细的调试信息
6. **文档更新：** 代码修改后要及时更新相关文档
7. **测试验证：** 修改后要进行完整的功能测试

---

## 文件依赖关系图

```
gameData.js (核心数据)
├── gameStateManager.js (状态管理)
├── gameEngine.js (游戏逻辑)
├── aiManager.js (AI交互)
├── promptBuilder.js (提示词构建)
├── uiManager.js (界面管理)
└── 文档文件
    ├── 游戏数据所有变量.md
    ├── 游戏脚本.md
    └── Debug手册.md
```

**注意：** 任何对核心文件的修改都可能影响其他文件，修改前请参考本手册进行全面检查。